name: 02-2 - Deploy CESIZen

on:
  workflow_call:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}
  IMAGE_NAME: ${{ github.repository }}

jobs:
  AzureDeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set IMAGE_NAME_LOWER
        run: |
          echo "IMAGE_NAME_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # - name: Database Backup
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.AZURE_HOST }}
      #     username: ${{ secrets.AZURE_LOGIN }}
      #     port: ${{ secrets.AZURE_PORT }}
      #     password: ${{ secrets.AZURE_PWD }}
      #     script: |
      #       echo "ðŸ’¾ Creating database backup for CESIZen..."
      #       BACKUP_FILE="cesizen_backup_$(date +%Y%m%d_%H%M%S).bak"
            
      #       # VÃ©rifier si le conteneur de base de donnÃ©es existe
      #       if docker ps -a --format "{{.Names}}" | grep -q "r2_database"; then
      #         docker exec r2_database /opt/mssql-tools/bin/sqlcmd \
      #           -S localhost -U sa -P "${{ secrets.DB_PASSWORD }}" \
      #           -Q "BACKUP DATABASE [RessourcesRelationnelles] TO DISK = '/var/opt/mssql/data/$BACKUP_FILE'" \
      #           || echo "âš ï¸ Database backup failed, but continuing deployment"
              
      #         echo "âœ… Database backup created: $BACKUP_FILE"
              
      #         # Garder seulement les 5 derniÃ¨res sauvegardes
      #         docker exec r2_database find /var/opt/mssql/data -name "cesizen_backup_*.bak" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | head -n -5 | cut -d' ' -f2- | xargs rm -f || true
      #       else
      #         echo "âš ï¸ Database container not found, skipping backup"
      #       fi

      - name: Update Compose File
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_LOGIN }}
          port: ${{ secrets.AZURE_PORT }}
          password: ${{ secrets.AZURE_PWD }}
          source: "./docker-compose.yml"
          target: "."

      - name: Canary Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_LOGIN }}
          port: ${{ secrets.AZURE_PORT }}
          password: ${{ secrets.AZURE_PWD }}
          script: |
            cd /opt/cesizen
            
            # Login Docker Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull nouvelle image
            NEW_IMAGE="ghcr.io/${{ env.IMAGE_NAME_LOWER }}:main-${{ github.sha }}"
            echo "ðŸ³ Pulling new image: $NEW_IMAGE"
            docker pull $NEW_IMAGE
            
            # CrÃ©er le rÃ©seau s'il n'existe pas
            docker network create r2-network 2>/dev/null || true
            
            # DÃ©ploiement Canary (10% du trafic)
            echo "ðŸš€ Starting canary deployment for CESIZen..."
            
            # Lancer le conteneur canary sur le port 8081
            docker compose up -d 
            
            # # Test Canary pendant 5 minutes
            # echo "ðŸ” Testing canary deployment..."
            # for i in {1..5}; do
            #   echo "Test $i/5 - Waiting 60 seconds..."
              
              # # Test de santÃ© de base
              # if ! curl -f http://localhost:8081/ > /dev/null 2>&1; then
              #   echo "âŒ Canary health check failed"
              #   docker stop cesizen-canary && docker rm cesizen-canary
              #   exit 1
              # fi
              
              # # Test de performance
              # RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:8081/)
              # echo "âš¡ Canary response time: ${RESPONSE_TIME}s"
              
              # if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
              #   echo "ðŸ”„ Rolling back due to performance issues"
              #   docker stop cesizen-canary && docker rm cesizen-canary
              #   exit 1
              # fi
              
            # # Si succÃ¨s, dÃ©ploiement complet
            # echo "ðŸŽ¯ Canary successful, proceeding with full deployment"
            
            # # Nettoyer le conteneur canary
            # docker stop cesizen-canary && docker rm cesizen-canary
            
            # # VÃ©rification finale
            # echo "ðŸ” Final health check..."
            # sleep 30
            
            if curl -f http://localhost:8080/ > /dev/null 2>&1; then
              echo "âœ… Full deployment successful!"
            else
              echo "âŒ Full deployment failed!"
              # Essayer de redÃ©marrer avec docker-compose en fallback
              echo "ðŸ”„ Attempting fallback with docker-compose..."
              docker-compose up -d r2-ui || exit 1
            fi
            
            # Nettoyer les anciennes images
            docker image prune -f
            
            echo "ðŸš€ CESIZen (RessourcesRelationnelles) deployment completed successfully!"

      # - name: Post-Deployment Tests
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.AZURE_HOST }}
      #     username: ${{ secrets.AZURE_LOGIN }}
      #     port: ${{ secrets.AZURE_PORT }}
      #     password: ${{ secrets.AZURE_PWD }}
      #     script: |
      #       echo "ðŸ§ª Running post-deployment tests for CESIZen..."
            
      #       # Test de base - homepage
      #       echo "Testing CESIZen homepage..."
      #       HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/)
      #       if [ "$HTTP_CODE" -eq 200 ]; then
      #         echo "âœ… Homepage accessible (HTTP $HTTP_CODE)"
      #       else
      #         echo "âŒ Homepage test failed (HTTP $HTTP_CODE)"
      #         exit 1
      #       fi
            
      #       # Test des endpoints Identity si disponibles
      #       echo "Testing Identity endpoints..."
      #       IDENTITY_CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/Identity/Account/Login)
      #       if [ "$IDENTITY_CODE" -eq 200 ]; then
      #         echo "âœ… Identity Login accessible (HTTP $IDENTITY_CODE)"
      #       else
      #         echo "âš ï¸ Identity Login not accessible (HTTP $IDENTITY_CODE) - but not critical"
      #       fi
            
      #       # Test de performance finale
      #       echo "Testing final performance..."
      #       RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:8080/)
      #       echo "âš¡ Production response time: ${RESPONSE_TIME}s"
            
      #       if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
      #         echo "âš ï¸ Production response time exceeds SLA: ${RESPONSE_TIME}s"
      #       else
      #         echo "âœ… Performance test passed: ${RESPONSE_TIME}s"
      #       fi
            
      #       # Test de la base de donnÃ©es (indirect)
      #       echo "Testing database connectivity..."
      #       if curl -s http://localhost:8080/ | grep -q "RessourcesRelationnelles\|CESIZen\|Ressources" 2>/dev/null; then
      #         echo "âœ… Application seems to be connected to database"
      #       else
      #         echo "âš ï¸ Cannot verify database connectivity"
      #       fi
            
      #       echo "âœ… All post-deployment tests completed!"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ CESIZen Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: CESIZen (RessourcesRelationnelles)" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production (Azure VM)" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Canary Deployment (10% â†’ 100%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ghcr.io/${{ env.IMAGE_NAME_LOWER }}:main-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${{ secrets.AZURE_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **SLA Target**: < 2 seconds response time" >> $GITHUB_STEP_SUMMARY
          echo "- **Monitoring**: Performance + Error rate + Availability" >> $GITHUB_STEP_SUMMARY